<!DOCTYPE html>
<html lang="en">
<head>

  <meta property="og:title" content="How funds with environmental, sustainability, or impact names have reacted to the ESMA Guidelines" />
  <meta property="og:description" content="This chart shows how funds with an environment sustainability, or impact-related name have reacted to the ESMA guidelines on funds with ESG or sustainability-related names" />
  <meta property="og:image" content="https://alisonschultz.github.io/esma/title_pic.png" />
  <meta property="og:url" content="https://alisonschultz.github.io/esma/" />

  <meta charset="UTF-8">
  <title>How funds with environmental, sustainability, or impact names have reacted to the ESMA Guidelines</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/d3-sankey@0.12.3"></script>
  <style>
    body {
      font-family: Verdana, sans-serif;
      margin: 0; padding: 0;
      display: flex; flex-direction: column;
      align-items: center; height: 100vh;
    }
    #controls {
      margin: 10px;
    }

    #controls label {
      font-size: 14px;
      margin-right: 6px;
    }
    #controls select {
      font-size: 14px;
      padding: 4px 6px;
      font-family: Verdana, sans-serif;
    }

    .link { fill: none; stroke-opacity: 0.5; transition: stroke-opacity 0.2s; }
    .link.highlight { stroke-opacity: 0.9; }
    .dimmed .link:not(.highlight) { stroke-opacity: 0.3; }
    .node rect { opacity: 0.6; transition: opacity 0.2s; }
    .node.highlight rect { opacity: 1 !important; }
    .dimmed .node rect:not(.highlight) { opacity: 0.3; }
    .tooltip {
      position: absolute; background: lightgrey;
      padding: 6px; border-radius: 4px;
      pointer-events: none; opacity: 0;
      transition: opacity 0.2s;
    }
    #chart { flex: 1; width: 100%; }
    svg { width: 100%; height: 100%; }
  </style>

</head>
<body>

  <div id="controls">
    <label for="amSelect">Investments:</label>
    <select id="amSelect">
      <option value="esi_gogcel" selected>Alle GOGEL und GCEL-Firmen</option>
      <option value="esi_pab">Firmen, die gegen die Paris-aligned Benchmark (PAB) verstoÃŸen</option>
      <option value="esi_expansion">Firmen, die ihre fossilen AktivitÃ¤ten ausbauen</option>
      <option value="esi_expansion_coal_expansion">Firmen mit Coal Expansion</option>
      <option value="esi_expansion_short_term_expansion_20_mmboe">Firmen mit Short-Term Expansion (â‰¥ 20 mmboe)</option>
      <option value="esi_expansion_pipeline_expansion_100_km">Firmen mit Pipeline Expansion (â‰¥ 100 km)</option>
      <option value="esi_expansion_lng_expansion_1_mtpa">Firmen mit LNG Expansion (â‰¥ 1 Mtpa)</option>
      <option value="esi_expansion_gas_fired_power_expansion_100_mw">Firmen mit Gas-Fired Power Expansion (â‰¥ 100 MW)</option>
      <option value="esi_expansion_oil_fired_power_expansion_100_mw">Firmen mit Oil-Fired Power Expansion (â‰¥ 100 MW)</option>
    </select>
  </div>

  <p style="margin: 10px; max-width: 700px; text-align: center;">
    ðŸ“„ <a href="https://isitchristmas.com/" target="_blank" style="text-decoration: none; color: #006699;">
      Hier geht's zur Studie ...[sobald sie existiert, bis dahin verlinke ich hier noch random stuff]
    </a>
  </p>

  <div id="chart"></div>
  <div class="tooltip" id="tooltip"></div>

  <script>
    // dimensions
    const margin = { top: 40, right: 20, bottom: 40, left: 20 };
    const fullW = 800, fullH = 500;
    const width  = fullW  - margin.left - margin.right;
    const height = fullH  - margin.top  - margin.bottom;

    // desired vertical order
    const order = [
      "left_fossil",
      "right_fossil",
      "right_renamed",
      "right_divested",
    ];

    const labels = {
      left_fossil:   "Investment",
      right_fossil:  "Investment",
      right_renamed: "Umbenennung",
      right_divested:"Divestment",
    };

    // rounded integer with thousands separator
    const fmt = d3.format(",.0f");

    // SVG setup
    const svg = d3.select("#chart")
      .append("svg")
        .attr("viewBox", `0 0 ${fullW} ${fullH}`)
        .attr("preserveAspectRatio", "xMinYMin meet")
      .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);
    const tooltip = d3.select("#tooltip");

    // helper to keep tooltip inside viewport
    function positionTooltip(e) {
      const tt = tooltip.node();
      const padding = 6;
      const tooltipWidth = tt.offsetWidth || 150;

      let x = e.pageX + padding;
      if (e.pageX + tooltipWidth + 2 * padding > window.innerWidth) {
        // place tooltip to the left of cursor if it would overflow on the right
        x = e.pageX - tooltipWidth - padding;
      }

      tooltip
        .style("left", x + "px")
        .style("top", (e.pageY - 6) + "px");
    }

    function loadChart(prefix) {
      svg.selectAll("*").remove();

      // recreate sankey generator each time to pick up nodeSort
      const sankeyGen = d3.sankey()
        .nodeWidth(20)
        .nodePadding(10)
        .extent([[1,1],[width-1,height-1]])
        .nodeAlign(d3.sankeyJustify)
        .nodeSort((a, b) => order.indexOf(a.name) - order.indexOf(b.name));

      Promise.all([
        d3.csv(`${prefix}_nodes.csv`),
        d3.csv(`${prefix}_links.csv`)
      ]).then(([nodesRaw, linksRaw]) => {
        const N = nodesRaw.length;

        // duplicate nodes left/right
        const sankeyNodes = nodesRaw
          .map(d => ({ name: d.kategorie.trim(), color: d.color, col: "L" }))
          .concat(
            nodesRaw.map(d => ({ name: d.kategorie.trim(), color: d.color, col: "R" }))
          );

        // build links
        const sankeyLinks = linksRaw
          .map(d => {
            const s = nodesRaw.findIndex(n => n.kategorie.trim() === d.source_kategorie.trim());
            const t = nodesRaw.findIndex(n => n.kategorie.trim() === d.target_kategorie.trim());
            return (s<0||t<0) ? null : { source: s, target: N + t, value: +d.value };
          })
          .filter(d => d);

        // compute layout with fresh sankeyGen
        const { nodes: Gnodes, links: Glinks } = sankeyGen({
          nodes: sankeyNodes,
          links: sankeyLinks
        });

        // gradients
        const defs = svg.append("defs");
        Glinks.forEach((link,i) => {
          const grad = defs.append("linearGradient")
            .attr("id", `grad${i}`)
            .attr("gradientUnits", "userSpaceOnUse")
            .attr("x1", link.source.x1)
            .attr("x2", link.target.x0);
          grad.append("stop").attr("offset","0%")
              .attr("stop-color", sankeyNodes[link.source.index].color);
          grad.append("stop").attr("offset","100%")
              .attr("stop-color", sankeyNodes[link.target.index].color);
        });

        // draw links
        svg.append("g")
          .selectAll("path")
          .data(Glinks)
          .enter().append("path")
            .attr("class","link")
            .attr("d", d3.sankeyLinkHorizontal())
            .attr("stroke-width", d=>Math.max(1,d.width))
            .attr("stroke",(d,i)=>`url(#grad${i})`)
            .on("mouseover",(e,d)=>{
              svg.classed("dimmed",true);
              d3.select(e.currentTarget).classed("highlight",true);
              tooltip.style("opacity",1)
                     .html(`${fmt(d.value)} Mil. â‚¬`);
              positionTooltip(e);
            })
            .on("mousemove",e=>{
              positionTooltip(e);
            })
            .on("mouseout",()=>{
              svg.classed("dimmed",false);
              d3.selectAll(".link").classed("highlight",false);
              tooltip.style("opacity",0);
            });

        // draw only nodes with flow
        const visibleNodes = Gnodes.filter(d => d.value > 0);

        // column headings
        const leftNodes = visibleNodes.filter(d => d.col === "L");
        const rightNodes = visibleNodes.filter(d => d.col === "R");
        const leftX = d3.min(leftNodes, d => d.x0);
        const rightX = d3.max(rightNodes, d => d.x1);

        svg.append("text")
          .attr("x", leftX)
          .attr("y", -15)
          .attr("text-anchor", "start")
          .style("font-size", "12px")
          .style("font-weight", "bold")
          .text("Vor ESMA-Leitlinien");

        svg.append("text")
          .attr("x", rightX - 6)
          .attr("y", -15)
          .attr("text-anchor", "end")
          .style("font-size", "12px")
          .style("font-weight", "bold")
          .text("Nach ESMA-Leitlinien");

        const node = svg.append("g")
          .selectAll("g")
          .data(visibleNodes)
          .enter().append("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${d.x0},${d.y0})`)
            .on("mouseover",(e,d)=>{
              svg.classed("dimmed",true);
              d3.select(e.currentTarget).classed("highlight",true);
              tooltip.style("opacity",1)
                     .html(`${labels[d.name] || d.name}: ${fmt(d.value)} Mil. â‚¬`);
              positionTooltip(e);
            })
            .on("mousemove",e=>{
              positionTooltip(e);
            })
            .on("mouseout",()=>{
              svg.classed("dimmed",false);
              d3.selectAll(".node").classed("highlight",false);
              tooltip.style("opacity",0);
            });

        node.append("rect")
          .attr("width", sankeyGen.nodeWidth())
          .attr("height", d=>d.y1-d.y0)
          .attr("fill", d=>d.color);

        node.append("text")
          .attr("x", d=> d.col==="L" ? sankeyGen.nodeWidth()+6 : -6)
          .attr("y", d=> (d.y1-d.y0)/2)
          .attr("dy","0.35em")
          .attr("text-anchor", d=> d.col==="L" ? "start" : "end")
          .style("font-size","12px")
          .text(d => labels[d.name] || d.name);

      })
      .catch(err => console.error("Failed to load CSVs or build sankey:", err));
    }

    // wire up dropdown & initial draw
    d3.select("#amSelect").on("change", function() {
      loadChart(this.value);
    });
    loadChart("esi_gogcel");
  </script>
</body>
</html>
